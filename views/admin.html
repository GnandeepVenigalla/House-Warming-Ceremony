<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RSVP Responses</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.noStyle.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div>
    <h1 class="text-2xl font-bold mb-4">Admin - RSVP Responses</h1>
    <div class="mb-4 flex flex-nowrap justify-between items-center gap-2 flex-wrap md:flex-nowrap">
      <div class="flex gap-2 flex-shrink-0">
        <button id="save-button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 whitespace-nowrap">Save Changes</button>
        <button id="download-button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 whitespace-nowrap">Download CSV</button>
      </div>
      <div class="flex flex-grow gap-4 items-center min-w-0">
        <input type="text" id="search-name" class="border rounded p-1 flex-grow min-w-0 max-w-xs md:max-w-md" placeholder="Search by name" />
        <select id="filter-attendance" class="border rounded p-1 flex-shrink-0">
          <option value="all">All</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>
    <div id="myGrid" class="ag-theme-alpine" style="height: 400px; width: 100%; max-width: 100vw;"></div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const gridOptions = {
        columnDefs: [
          { headerName: "First Name", field: "firstName", editable: true, filter: 'agTextColumnFilter' },
          { headerName: "Last Name", field: "lastName", editable: true, filter: 'agTextColumnFilter' },
          { headerName: "Attendance", field: "attendance", editable: true, filter: 'agSetColumnFilter', cellEditor: 'agSelectCellEditor', cellEditorParams: { values: ['yes', 'no'] } },
          { headerName: "Adults", field: "adults", editable: true, filter: 'agNumberColumnFilter', type: 'numericColumn' },
          { headerName: "Kids", field: "kids", editable: true, filter: 'agNumberColumnFilter', type: 'numericColumn' },
          { headerName: "Contact", field: "contact", editable: true, filter: 'agTextColumnFilter' },
          { headerName: "Comment", field: "comment", editable: true, filter: 'agTextColumnFilter' },
          { headerName: "Actions", field: "_id", cellRenderer: function(params) {
              return `<button class="delete-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" data-id="${params.value}">Delete</button>`;
            }
          }
        ],
        defaultColDef: {
          sortable: true,
          resizable: true,
          flex: 1,
          minWidth: 100,
        },
        rowData: null,
        animateRows: true,
        onCellValueChanged: function(event) {
          // Optionally handle cell value changes here
        }
      };

      const eGridDiv = document.querySelector('#myGrid');
      new agGrid.Grid(eGridDiv, gridOptions);

      eGridDiv.style.width = '100%';
      eGridDiv.style.maxWidth = '100vw';

      gridOptions.onGridReady = function(params) {
        params.api.sizeColumnsToFit();
      };

      async function fetchRSVPs() {
        try {
          console.log('Fetching RSVP data...');
          const response = await fetch('https://house-warming-ceremony.onrender.com/api/rsvps');
          if (!response.ok) {
            console.error('Failed to fetch RSVP data: HTTP status', response.status);
            return;
          }
          const data = await response.json();
          console.log('RSVP data received:', data);
          if (!data || data.length === 0) {
            console.warn('No RSVP data available to display.');
          }
          gridOptions.api.setRowData(data);
          gridOptions.api.sizeColumnsToFit();
        } catch (error) {
          console.error('Failed to fetch RSVP data:', error);
        }
      }

      fetchRSVPs();

      // Save button handler
      document.getElementById('save-button').addEventListener('click', async () => {
        const updatedRows = [];
        gridOptions.api.forEachNode(node => {
          if (node.data && node.data._id) {
            updatedRows.push(node.data);
          }
        });

        for (const row of updatedRows) {
          try {
            const response = await fetch(`https://house-warming-ceremony.onrender.com/rsvp/${row._id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(row),
            });
            if (!response.ok) {
              alert(`Failed to update RSVP for ${row.firstName} ${row.lastName}`);
            }
          } catch (error) {
            alert(`Error updating RSVP for ${row.firstName} ${row.lastName}`);
            console.error(error);
          }
        }
        alert('All changes saved.');
        fetchRSVPs();
      });

      // Delete button handler using event delegation
      eGridDiv.addEventListener('click', async (event) => {
        if (event.target.classList.contains('delete-btn')) {
          const id = event.target.getAttribute('data-id');
          if (confirm('Are you sure you want to delete this RSVP?')) {
            try {
              const response = await fetch(`https://house-warming-ceremony.onrender.com/rsvp/${id}`, {
                method: 'DELETE',
              });
              if (response.ok) {
                alert('RSVP deleted successfully.');
                fetchRSVPs();
              } else {
                alert('Failed to delete RSVP.');
              }
            } catch (error) {
              alert('Error deleting RSVP.');
              console.error(error);
            }
          }
        }
      });

      // Search and filter
      const searchInput = document.getElementById('search-name');
      const filterSelect = document.getElementById('filter-attendance');

      function filterGrid() {
        const searchValue = searchInput.value.toLowerCase();
        const filterValue = filterSelect.value;

        gridOptions.api.setQuickFilter(searchValue);

        if (filterValue === 'all') {
          gridOptions.api.setFilterModel(null);
        } else {
          gridOptions.api.setFilterModel({ attendance: { type: 'equals', filter: filterValue } });
        }
      }

      searchInput.addEventListener('input', filterGrid);
      filterSelect.addEventListener('change', filterGrid);
    });
  </script>
</body>
</html>
